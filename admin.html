<!DOCTYPE html>
<html class="light" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Admin Dashboard - QuizApp</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&amp;display=swap" rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
        rel="stylesheet" />
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#4A90E2",
                        "background-light": "#F4F4F4",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"]
                    },
                },
            },
        }
    </script>
    <script src="qa_data.js"></script>
    <script>
        // Expose data to window for module access
        if (typeof allQuestionsData !== 'undefined') {
            window.allQuestionsData = allQuestionsData;
        }

        // Check for token and admin role
        const token = localStorage.getItem('token');
        const role = localStorage.getItem('role');
        if (!token || role !== 'admin') {
            window.location.href = 'index.html';
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('role');
            localStorage.removeItem('username');
            window.location.href = 'index.html';
        }
    </script>
</head>

<body class="font-display bg-slate-50 dark:bg-slate-900 min-h-screen flex flex-col md:flex-row">
    <!-- Sidebar -->
    <aside
        class="w-full md:w-64 bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 flex-shrink-0 sticky top-0 md:h-screen z-20">
        <div class="p-6 border-b border-slate-200 dark:border-slate-700 flex items-center gap-3">
            <div
                class="size-8 rounded-lg bg-gradient-to-tr from-blue-500 to-indigo-600 text-white flex items-center justify-center shadow-lg shadow-blue-500/20">
                <span class="material-symbols-outlined text-xl">admin_panel_settings</span>
            </div>
            <span
                class="text-lg font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600 dark:from-blue-400 dark:to-indigo-400">Admin</span>
        </div>

        <nav class="p-4 space-y-2">
            <button onclick="switchTab('stats')" id="nav-stats"
                class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left font-medium transition-all duration-200 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400">
                <span class="material-symbols-outlined">analytics</span>
                Statistics
            </button>
            <button onclick="switchTab('question-stats')" id="nav-question-stats"
                class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left font-medium text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-all duration-200">
                <span class="material-symbols-outlined">quiz</span>
                Question Stats
            </button>
            <button onclick="switchTab('create-user')" id="nav-create-user"
                class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left font-medium text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-all duration-200">
                <span class="material-symbols-outlined">person_add</span>
                Create Account
            </button>
            <button onclick="switchTab('ai-analysis')" id="nav-ai-analysis"
                class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left font-medium text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-all duration-200">
                <span class="material-symbols-outlined">smart_toy</span>
                AI Analysis
            </button>
        </nav>

        <div class="p-4 mt-auto border-t border-slate-200 dark:border-slate-700">
            <button onclick="logout()"
                class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left font-medium text-slate-500 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/10 transition-all duration-200">
                <span class="material-symbols-outlined">logout</span>
                Logout
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-grow p-6 md:p-8 overflow-y-auto h-screen">
        <div class="max-w-5xl mx-auto">

            <!-- Statistics Section -->
            <section id="stats-section" class="animate-fade-in">
                <div class="mb-8">
                    <h1 class="text-3xl font-bold text-slate-900 dark:text-white mb-2">Exam Statistics
                    </h1>
                    <p class="text-slate-500 dark:text-slate-400">Overview of student performance and
                        quiz attempts.</p>
                </div>

                <div
                    class="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr
                                    class="bg-slate-50/50 dark:bg-slate-700/50 border-b border-slate-200 dark:border-slate-700">
                                    <th
                                        class="p-5 font-bold text-slate-500 dark:text-slate-400 text-xs uppercase tracking-wider">
                                        User / Full Name</th>
                                    <th
                                        class="p-5 font-bold text-slate-500 dark:text-slate-400 text-xs uppercase tracking-wider">
                                        Exam ID</th>
                                    <th
                                        class="p-5 font-bold text-slate-500 dark:text-slate-400 text-xs uppercase tracking-wider text-center">
                                        Attempts</th>
                                    <th
                                        class="p-5 font-bold text-slate-500 dark:text-slate-400 text-xs uppercase tracking-wider text-center">
                                        Avg Score</th>
                                    <th
                                        class="p-5 font-bold text-slate-500 dark:text-slate-400 text-xs uppercase tracking-wider text-center">
                                        Highest</th>
                                    <th
                                        class="p-5 font-bold text-slate-500 dark:text-slate-400 text-xs uppercase tracking-wider text-right">
                                        Last Attempt</th>
                                </tr>
                            </thead>
                            <tbody id="stats-body" class="divide-y divide-slate-100 dark:divide-slate-700">
                                <tr>
                                    <td colspan="6" class="p-12 text-center">
                                        <div class="flex flex-col items-center gap-3 text-slate-400">
                                            <span class="material-symbols-outlined text-4xl animate-spin">refresh</span>
                                            <span class="font-medium">Loading statistics...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Question Stats Section -->
            <section id="question-stats-section" class="hidden animate-fade-in">
                <div class="mb-8">
                    <h1 class="text-3xl font-bold text-slate-900 dark:text-white mb-2">Question
                        Statistics</h1>
                    <p class="text-slate-500 dark:text-slate-400">Analyze performance per question.</p>
                </div>

                <div
                    class="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr
                                    class="bg-slate-50/50 dark:bg-slate-700/50 border-b border-slate-200 dark:border-slate-700">
                                    <th
                                        class="p-5 font-bold text-slate-500 dark:text-slate-400 text-xs uppercase tracking-wider w-16">
                                        ID</th>
                                    <th
                                        class="p-5 font-bold text-slate-500 dark:text-slate-400 text-xs uppercase tracking-wider">
                                        Question</th>
                                    <th
                                        class="p-5 font-bold text-slate-500 dark:text-slate-400 text-xs uppercase tracking-wider text-center">
                                        Attempts</th>
                                    <th
                                        class="p-5 font-bold text-slate-500 dark:text-slate-400 text-xs uppercase tracking-wider text-center">
                                        Correct %</th>
                                </tr>
                            </thead>
                            <tbody id="question-stats-body" class="divide-y divide-slate-100 dark:divide-slate-700">
                                <tr>
                                    <td colspan="4" class="p-12 text-center">
                                        <div class="flex flex-col items-center gap-3 text-slate-400">
                                            <span class="material-symbols-outlined text-4xl animate-spin">refresh</span>
                                            <span class="font-medium">Loading question
                                                statistics...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Create User Section -->
            <section id="create-user-section" class="hidden animate-fade-in">
                <div class="mb-8">
                    <h1 class="text-3xl font-bold text-slate-900 dark:text-white mb-2">Create Account
                    </h1>
                    <p class="text-slate-500 dark:text-slate-400">Add a new student account to the
                        system.</p>
                </div>

                <div class="max-w-xl">
                    <div
                        class="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm p-8">
                        <form id="create-user-form" class="space-y-6">
                            <div class="space-y-2">
                                <label
                                    class="block text-sm font-bold text-slate-700 dark:text-slate-300">Username</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                        <span class="material-symbols-outlined text-slate-400">person</span>
                                    </div>
                                    <input type="text" id="new-username" required
                                        class="w-full pl-11 pr-4 py-3 rounded-xl bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition-all text-slate-900 dark:text-white placeholder-slate-400 font-medium"
                                        placeholder="Enter username">
                                </div>
                            </div>

                            <div class="space-y-2">
                                <label class="block text-sm font-bold text-slate-700 dark:text-slate-300">Full
                                    Name</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                        <span class="material-symbols-outlined text-slate-400">badge</span>
                                    </div>
                                    <input type="text" id="new-fullname"
                                        class="w-full pl-11 pr-4 py-3 rounded-xl bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition-all text-slate-900 dark:text-white placeholder-slate-400 font-medium"
                                        placeholder="Enter full name">
                                </div>
                            </div>

                            <div class="space-y-2">
                                <label
                                    class="block text-sm font-bold text-slate-700 dark:text-slate-300">Password</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                        <span class="material-symbols-outlined text-slate-400">lock</span>
                                    </div>
                                    <input type="password" id="new-password" required
                                        class="w-full pl-11 pr-4 py-3 rounded-xl bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition-all text-slate-900 dark:text-white placeholder-slate-400 font-medium"
                                        placeholder="Enter password">
                                </div>
                            </div>

                            <button type="submit"
                                class="w-full py-3.5 px-4 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold rounded-xl shadow-lg shadow-blue-500/30 hover:shadow-blue-500/40 transition-all transform hover:-translate-y-0.5 flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined">add_circle</span> Create Account
                            </button>
                        </form>
                    </div>
                </div>
            </section>

            <!-- AI Analysis Section -->
            <section id="ai-analysis-section" class="hidden animate-fade-in h-[calc(100vh-140px)] flex flex-col">
                <div class="mb-4 flex-shrink-0">
                    <h1 class="text-3xl font-bold text-slate-900 dark:text-white mb-2 flex items-center gap-2">
                        <span class="material-symbols-outlined text-blue-600">smart_toy</span>
                        AI Data Analysis
                    </h1>
                    <p class="text-slate-500 dark:text-slate-400">Ask Nor to analyze exam results and
                        question performance.</p>
                </div>

                <div
                    class="flex-grow bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm overflow-hidden flex flex-col">
                    <!-- Chat Messages -->
                    <div id="ai-messages" class="flex-grow p-6 overflow-y-auto space-y-4 scroll-smooth">
                        <!-- Welcome Message -->
                        <div class="flex gap-4 max-w-3xl">
                            <div
                                class="w-10 h-10 rounded-full bg-gradient-to-tr from-blue-500 to-indigo-600 flex items-center justify-center text-white flex-shrink-0 shadow-lg shadow-blue-500/20">
                                <span class="material-symbols-outlined text-xl">smart_toy</span>
                            </div>
                            <div class="flex flex-col gap-1">
                                <span class="text-sm font-bold text-slate-700 dark:text-slate-300">Nor
                                    (AI Analyst)</span>
                                <div
                                    class="p-4 bg-slate-50 dark:bg-slate-700/50 rounded-2xl rounded-tl-none text-slate-700 dark:text-slate-300 leading-relaxed shadow-sm border border-slate-100 dark:border-slate-600">
                                    Xin chào! Tôi là Nor, trợ lý AI phân tích dữ liệu. Tôi có thể giúp
                                    bạn tìm ra câu hỏi khó nhất, phân tích kết quả của sinh viên, hoặc
                                    đưa ra gợi ý cải thiện ngân hàng câu hỏi. Bạn muốn biết gì nào? ✨
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="p-4 bg-slate-50 dark:bg-slate-900 border-t border-slate-200 dark:border-slate-700">
                        <div class="relative max-w-4xl mx-auto">
                            <textarea id="ai-input" rows="1"
                                class="w-full pl-5 pr-14 py-4 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition-all text-slate-900 dark:text-white placeholder-slate-400 font-medium resize-none shadow-sm"
                                placeholder="Ask about statistics, difficult questions, or user performance..."></textarea>
                            <button id="ai-send-btn"
                                class="absolute right-2 bottom-2 p-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors shadow-md shadow-blue-500/20 disabled:opacity-50 disabled:cursor-not-allowed">
                                <span class="material-symbols-outlined">send</span>
                            </button>
                        </div>
                        <div class="text-center mt-2">
                            <p class="text-xs text-slate-400 dark:text-slate-500">AI có thể mắc lỗi. Hãy
                                kiểm tra lại thông tin quan trọng.</p>
                        </div>
                    </div>
                </div>
                <script>
                    // Tab Switching Logic
                    function switchTab(tabId) {
                        // Hide all sections
                        document.querySelectorAll('section').forEach(el => {
                            el.classList.add('hidden');
                        });

                        // Show selected section
                        const selectedSection = document.getElementById(`${tabId}-section`);
                        if (selectedSection) {
                            selectedSection.classList.remove('hidden');
                        }

                        // Update active state of nav buttons
                        document.querySelectorAll('nav button').forEach(btn => {
                            btn.classList.remove('bg-blue-50', 'dark:bg-blue-900/20', 'text-blue-600', 'dark:text-blue-400');
                            btn.classList.add('text-slate-600', 'dark:text-slate-400', 'hover:bg-slate-50', 'dark:hover:bg-slate-700/50');
                        });

                        const activeBtn = document.getElementById(`nav-${tabId}`);
                        if (activeBtn) {
                            activeBtn.classList.remove('text-slate-600', 'dark:text-slate-400', 'hover:bg-slate-50', 'dark:hover:bg-slate-700/50');
                            activeBtn.classList.add('bg-blue-50', 'dark:bg-blue-900/20', 'text-blue-600', 'dark:text-blue-400');
                        }

                        // Load data based on tab
                        if (tabId === 'stats') {
                            loadStats();
                        } else if (tabId === 'question-stats') {
                            loadQuestionStats();
                        }
                    }

                    // Load Exam Statistics
                    async function loadStats() {
                        const token = localStorage.getItem('token');
                        try {
                            const response = await fetch('/api/admin/stats', {
                                headers: { 'Authorization': token }
                            });

                            if (response.ok) {
                                const stats = await response.json();
                                window.allUserStats = stats; // Store for AI
                                renderStats(stats);
                            } else {
                                throw new Error('Failed to fetch stats');
                            }
                        } catch (error) {
                            console.error('Error loading stats:', error);
                            document.getElementById('stats-body').innerHTML = `
                                            <tr>
                                                <td colspan="6" class="p-12 text-center text-red-500">
                                                    Error loading statistics. Please try again.
                                                </td>
                                            </tr>`;
                        }
                    }

                    function renderStats(stats) {
                        const tbody = document.getElementById('stats-body');
                        if (stats.length === 0) {
                            tbody.innerHTML = `<tr><td colspan="6" class="p-12 text-center text-slate-500">No data available.</td></tr>`;
                            return;
                        }

                        tbody.innerHTML = stats.map(row => `
                                            <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors">
                                                <td class="p-5">
                                                    <div class="flex flex-col">
                                                        <span class="font-bold text-slate-900 dark:text-white">${row.fullname}</span>
                                                        <span class="text-xs text-slate-500">@${row.username}</span>
                                                    </div>
                                                </td>
                                                <td class="p-5 font-mono text-sm text-slate-500 dark:text-slate-400">${row.exam_id}</td>
                                                <td class="p-5 text-center text-slate-700 dark:text-slate-300 font-medium">${row.attempt_count}</td>
                                                <td class="p-5 text-center">
                                                    <span class="inline-flex items-center justify-center min-w-[3rem] px-2 py-1 rounded-lg font-bold text-sm ${getScoreBadgeColor(row.average_score)}">
                                                        ${parseFloat(row.average_score).toFixed(1)}
                                                    </span>
                                                </td>
                                                <td class="p-5 text-center font-bold text-slate-700 dark:text-slate-300">${row.highest_score}</td>
                                                <td class="p-5 text-right text-slate-500 dark:text-slate-400 text-sm">
                                                    ${new Date(row.last_attempt).toLocaleDateString('vi-VN')}
                                                </td>
                                            </tr>
                                            `).join('');
                    }

                    // Load Question Statistics
                    async function loadQuestionStats() {
                        const token = localStorage.getItem('token');
                        try {
                            const response = await fetch('/api/admin/question-stats', {
                                headers: { 'Authorization': token }
                            });

                            if (response.ok) {
                                const stats = await response.json();
                                window.allQuestionStats = stats; // Store for AI
                                renderQuestionStats(stats);
                            } else {
                                throw new Error('Failed to fetch question stats');
                            }
                        } catch (error) {
                            console.error('Error loading question stats:', error);
                            document.getElementById('question-stats-body').innerHTML = `
                                            <tr>
                                                <td colspan="4" class="p-12 text-center text-red-500">
                                                    Error loading question statistics.
                                                </td>
                                            </tr>`;
                        }
                    }

                    function renderQuestionStats(stats) {
                        const tbody = document.getElementById('question-stats-body');
                        if (stats.length === 0) {
                            tbody.innerHTML = `<tr><td colspan="4" class="p-12 text-center text-slate-500">No data available.</td></tr>`;
                            return;
                        }

                        tbody.innerHTML = stats.map(row => {
                            // Find question text from qa_data.js
                            const questionData = typeof allQuestionsData !== 'undefined'
                                ? allQuestionsData.find(q => q.id == row.question_id)
                                : null;
                            const questionText = questionData ? questionData.question : `Question ID: ${row.question_id}`;

                            return `
                                            <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors">
                                                <td class="p-5 font-mono text-sm text-slate-500 dark:text-slate-400">#${row.question_id}</td>
                                                <td class="p-5 font-medium text-slate-900 dark:text-white max-w-lg truncate" title="${questionText}">
                                                    ${questionText}
                                                </td>
                                                <td class="p-5 text-center text-slate-700 dark:text-slate-300 font-medium">${row.total_attempts}</td>
                                                <td class="p-5 text-center">
                                                    <span class="inline-flex items-center justify-center min-w-[3rem] px-2 py-1 rounded-lg font-bold text-sm ${getScoreBadgeColor(row.correct_percentage / 10)}">
                                                        ${parseFloat(row.correct_percentage).toFixed(1)}%
                                                    </span>
                                                </td>
                                            </tr>
                `}).join('');
                    }

                    function getScoreBadgeColor(score) {
                        if (score >= 8) return 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400 border border-green-200 dark:border-green-900/50';
                        if (score >= 5) return 'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400 border border-amber-200 dark:border-amber-900/50';
                        return 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400 border border-red-200 dark:border-red-900/50';
                    }

                    // Initialize
                    document.addEventListener('DOMContentLoaded', () => {
                        switchTab('stats');

                        // Handle Create User Form
                        document.getElementById('create-user-form').addEventListener('submit', async (e) => {
                            e.preventDefault();
                            const username = document.getElementById('new-username').value;
                            const password = document.getElementById('new-password').value;
                            const fullname = document.getElementById('new-fullname').value;
                            const btn = e.target.querySelector('button');
                            const originalText = btn.innerHTML;

                            btn.disabled = true;
                            btn.innerHTML = '<span class="material-symbols-outlined animate-spin text-lg">refresh</span> Creating...';

                            try {
                                const response = await fetch('/api/auth/register', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ username, password, fullname })
                                });

                                const data = await response.json();

                                if (response.ok) {
                                    const form = document.getElementById('create-user-form');
                                    const successMsg = document.createElement('div');
                                    successMsg.className = 'p-3 rounded-xl bg-green-50 text-green-600 text-sm font-medium border border-green-100 flex items-center gap-2 animate-fade-in';
                                    successMsg.innerHTML = '<span class="material-symbols-outlined text-lg">check_circle</span> Account created successfully!';
                                    form.appendChild(successMsg);

                                    form.reset();
                                    setTimeout(() => successMsg.remove(), 3000);
                                } else {
                                    alert(data.message || 'Failed to create account');
                                }
                            } catch (error) {
                                console.error('Error creating user:', error);
                                alert('An error occurred. Please try again.');
                            } finally {
                                btn.disabled = false;
                                btn.innerHTML = originalText;
                            }
                        });
                    });
                </script>
                <script type="module" src="admin_ai.js"></script>
</body>

</html>